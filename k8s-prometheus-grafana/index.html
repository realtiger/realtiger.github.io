<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="aaron">



<meta name="description" content="全部的 K8S学习笔记总目录，请点击查看。 我们已经有了一些监控数据了，但是我们还需要一个监控面板，来展示我们的监控数据，这里我们使用Grafana来展示我们的监控数据。">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s prometheus 展示与告警">
<meta property="og:url" content="http://realtiger.github.io/k8s-prometheus-grafana/index.html">
<meta property="og:site_name" content="一雾银的博客">
<meta property="og:description" content="全部的 K8S学习笔记总目录，请点击查看。 我们已经有了一些监控数据了，但是我们还需要一个监控面板，来展示我们的监控数据，这里我们使用Grafana来展示我们的监控数据。">
<meta property="og:locale">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-login.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-dashboard.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-node-exporter-dashboard.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-import.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-import-enter-id.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-import-load.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-import-info.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-k8s-dashboard.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-k8s-info.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-plugins.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-plugins-list.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-plugins-kubegraf.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-dashboard.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-data-source.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-apply.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-variables.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-variables-add.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-variables-info.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-variables-preview.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-variables-success.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-variables-select.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-metrics.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-metrics-success.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-new-panel-metrics-cpu.jpg">
<meta property="og:image" content="http://realtiger.github.io/post/docker/alertmanager.png">
<meta property="og:image" content="http://realtiger.github.io/post/docker/alertmanager.png">
<meta property="og:image" content="http://realtiger.github.io/post/docker/alertmanager-process.png">
<meta property="og:image" content="http://realtiger.github.io/post/docker/hpa-prometheus-custom.png">
<meta property="og:image" content="http://realtiger.github.io/post/docker/k8s-metrics.png">
<meta property="og:image" content="http://realtiger.github.io/post/docker/hpa-prometheus-custom.png">
<meta property="og:image" content="http://realtiger.github.io/post/docker/customer-metrics.png">
<meta property="article:published_time" content="2023-12-06T05:51:19.000Z">
<meta property="article:modified_time" content="2023-12-11T17:33:52.853Z">
<meta property="article:author" content="aaron">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="prometheus">
<meta property="article:tag" content="grafana">
<meta property="article:tag" content="alertmanager">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://realtiger.github.io/post/docker/k8s-prometheus-grafana-login.jpg">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="一雾银的博客" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">




<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>k8s prometheus 展示与告警 | 一雾银的博客</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






<meta name="generator" content="Hexo 6.3.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">aaron</a></h1>
        </hgroup>

        
        <p class="header-subtitle">不爱游戏的程序员不是一个好厨师</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload>
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class="no-result">No results found <i class="fa fa-spinner fa-pulse"></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:ganchangde@163.com" title="Email" rel="external nofollow noopener noreferrer" target="_blank"></a>
                            
                                <a class="fa GitHub" target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/realtiger" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zhihu.com/people/realtiger" title="知乎"></a>
                            
                                <a class="fa 博客园" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/cdinc" title="博客园"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/StorageClass/" rel="tag">StorageClass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alertmanager/" rel="tag">alertmanager</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auth/" rel="tag">auth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/certificate/" rel="tag">certificate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ci-cd/" rel="tag">ci&#x2F;cd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cni/" rel="tag">cni</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/containerd/" rel="tag">containerd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devops/" rel="tag">devops</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/etcd/" rel="tag">etcd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/" rel="tag">grafana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/helm/" rel="tag">helm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hpa/" rel="tag">hpa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/httpx/" rel="tag">httpx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monitoring/" rel="tag">monitoring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/" rel="tag">prometheus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pv/" rel="tag">pv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pvc/" rel="tag">pvc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rabbitmq/" rel="tag">rabbitmq</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scheduler/" rel="tag">scheduler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/targets/" rel="tag">targets</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="external nofollow noopener noreferrer" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="external nofollow noopener noreferrer" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="external nofollow noopener noreferrer" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">一个啥都想学的菜鸡</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">aaron</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">aaron</a></h1>
            </hgroup>
            
            <p class="header-subtitle">不爱游戏的程序员不是一个好厨师</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:ganchangde@163.com" title="Email" rel="external nofollow noopener noreferrer"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/realtiger" title="GitHub" rel="external nofollow noopener noreferrer"></a>
                            
                                <a class="fa 知乎" target="_blank" href="https://www.zhihu.com/people/realtiger" title="知乎" rel="external nofollow noopener noreferrer"></a>
                            
                                <a class="fa 博客园" target="_blank" href="https://www.cnblogs.com/cdinc" title="博客园" rel="external nofollow noopener noreferrer"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap"><article id="post-k8s-prometheus-grafana" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/k8s-prometheus-grafana/" class="article-date">
      <time datetime="2023-12-06T05:51:19.000Z" itemprop="datePublished">2023-12-06</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      k8s prometheus 展示与告警
    </h1>
  

          
              <div style="margin-top:10px">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <span class="post-count">12.3k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">52分</span>
      </span>
    </span>
</div>
          
      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/alertmanager/" rel="tag">alertmanager</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/grafana/" rel="tag">grafana</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/prometheus/" rel="tag">prometheus</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>全部的 <a href="https://realtiger.github.io/k8s-learning/">K8S学习笔记总目录</a>，请点击查看。</p>
<p>我们已经有了一些监控数据了，但是我们还需要一个监控面板，来展示我们的监控数据，这里我们使用Grafana来展示我们的监控数据。</p>
<span id="more"></span>

<h1 id="Grafana介绍"><a href="#Grafana介绍" class="headerlink" title="Grafana介绍"></a>Grafana介绍</h1><p>Grafana 是一个开源的度量分析和可视化工具，可以通过将采集的数据查询展示成漂亮的图表，并且提供了丰富的插件支持。支持 Graphite、zabbix、InfluxDB、Prometheus、OpenTSDB、Elasticsearch 等作为数据源，比 Prometheus 自带的图表展示功能强大太多，更加灵活，有丰富的插件，功能更加强大。</p>
<h1 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h1><p>最新的安装方式可以参考官方文档：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/kubernetes/">在Kubernetes上安装Grafana</a>，里面有资源配置清单可以参考进行安装。这里我们使用helm进行安装，如果想要单独安装请参考官方文档。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加helm仓库</span></span><br><span class="line">$ helm repo add grafana https://grafana.github.io/helm-charts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看chart版本</span></span><br><span class="line">$ helm search repo grafana</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载chart</span></span><br><span class="line">$ helm pull grafana/grafana</span><br><span class="line"><span class="comment"># 解压chart</span></span><br><span class="line">$ tar -zxvf grafana-7.0.11.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改values.yaml</span></span><br><span class="line">$ vim grafana/values.yaml</span><br><span class="line">......</span><br><span class="line">testFramework:</span><br><span class="line">  <span class="comment"># 不需要测试，将其设置为false</span></span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line">  image:</span><br><span class="line">    <span class="comment"># -- The Docker registry</span></span><br><span class="line">    registry: docker.io</span><br><span class="line">    repository: bats/bats</span><br><span class="line">    tag: <span class="string">&quot;v1.4.1&quot;</span></span><br><span class="line">......</span><br><span class="line">ingress:</span><br><span class="line">  <span class="comment"># 开启ingress</span></span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  ......</span><br><span class="line">  hosts:</span><br><span class="line">    <span class="comment"># 设置ingress访问域名</span></span><br><span class="line">    - grafana.test.com</span><br><span class="line">......</span><br><span class="line">persistence:</span><br><span class="line">  <span class="built_in">type</span>: pvc</span><br><span class="line">  <span class="comment"># 启用持久化存储</span></span><br><span class="line">  enabled: <span class="built_in">enable</span></span><br><span class="line">  <span class="comment"># 设置sc的名称是nfs-client，这个sc是我们之前创建的。</span></span><br><span class="line">  <span class="comment"># 如果本身已经有pvc，可以将这个值设置为false，然后将pvc的名称设置到existingClaim中</span></span><br><span class="line">  storageClassName: nfs-client</span><br><span class="line">......</span><br><span class="line"><span class="comment"># web ui 登录的用户名和密码</span></span><br><span class="line"><span class="comment"># Administrator credentials when not using an existing secret (see below)</span></span><br><span class="line">adminUser: admin</span><br><span class="line">adminPassword: strongpassword</span><br><span class="line">......</span><br><span class="line">datasources:</span><br><span class="line">  <span class="comment"># 启用datasources并且设置数据源文件，文件中记录了prometheus的地址，这样grafana安装后默认就有了prometheus的数据源</span></span><br><span class="line">  datasources.yaml:</span><br><span class="line">    apiVersion: 1</span><br><span class="line">    datasources:</span><br><span class="line">    - name: Prometheus</span><br><span class="line">      <span class="built_in">type</span>: prometheus</span><br><span class="line">      <span class="comment"># 这里的url是prometheus的地址，这里我们使用prometheus的service地址</span></span><br><span class="line">      url: http://prometheus:9090</span><br><span class="line">      access: proxy</span><br><span class="line">      isDefault: <span class="literal">true</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装grafana</span></span><br><span class="line">$ helm install grafana ./grafana -n monitor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看grafana的pod状态</span></span><br><span class="line">$ kubectl get pod -n monitor</span><br></pre></td></tr></table></figure>

<p>安装完成后，我们就可以访问grafana了。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-login.jpg" alt="k8s-prometheus-grafana-login"></p>
<p>使用上面配置的用户名和密码登录后，我们就可以看到grafana的首页了。但是目前的grafana还没有任何的监控面板，我们需要导入一些监控面板。</p>
<h1 id="导入监控面板"><a href="#导入监控面板" class="headerlink" title="导入监控面板"></a>导入监控面板</h1><p>导入监控面板主要有三种方式：</p>
<ul>
<li>导入dashboard</li>
<li>安装相应的插件</li>
<li>自定义监控面板</li>
</ul>
<h2 id="导入Dashboard的配置"><a href="#导入Dashboard的配置" class="headerlink" title="导入Dashboard的配置"></a>导入Dashboard的配置</h2><p>官方已经提供了一些Dashboard的配置，我们可以直接导入使用，可以在<a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/dashboards">官方Dashboard列表</a>中找到需要的Dashboard。</p>
<p>这里我们导入两个Dashboard：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/dashboards/15172-node-exporter-for-prometheus-dashboard-based-on-11074/">Node Exporter</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/dashboards/13105">Kubernetes</a></li>
</ul>
<h3 id="官方提供的Dashboard"><a href="#官方提供的Dashboard" class="headerlink" title="官方提供的Dashboard"></a>官方提供的Dashboard</h3><p>进入官方提供的Dashboard页面，可以看到有很多的Dashboard样式，我们可以根据自己的需求进行选择，进行不同的筛选，选到自己的Dashboard后，点击进入详情页面，可以看到Dashboard的ID，我们可以通过这个ID来导入Dashboard。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-dashboard.jpg" alt="k8s-prometheus-grafana-dashboard"></p>
<h3 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node Exporter"></a>Node Exporter</h3><p>这个Dashboard是用来监控节点的，我们可以看到节点的CPU、内存、磁盘、网络等信息。</p>
<p>我们从官方提供的Dashboard页面中找到这个Dashboard，进入详情页面，可以看到Dashboard的ID为15172，我们可以通过这个ID来导入Dashboard。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-node-exporter-dashboard.jpg" alt="k8s-prometheus-grafana-node-exporter-dashboard"></p>
<p>进入grafana的首页，点击[+]按钮，选择Import</p>
<p><img src="/post/docker/k8s-prometheus-grafana-import.jpg" alt="k8s-prometheus-grafana-import"></p>
<p>在输入框中输入Dashboard的ID，点击Load按钮</p>
<p><img src="/post/docker/k8s-prometheus-grafana-import-enter-id.jpg" alt="k8s-prometheus-grafana-import-enter-id"></p>
<p>然后可以看到Dashboard的信息，点击Import按钮导入Dashboard</p>
<p><img src="/post/docker/k8s-prometheus-grafana-import-load.jpg" alt="k8s-prometheus-grafana-import-load"></p>
<p>导入成功后，可以看到Dashboard的信息</p>
<p><img src="/post/docker/k8s-prometheus-grafana-import-info.jpg" alt="k8s-prometheus-grafana-import-info"></p>
<h3 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h3><p>按照上面的步骤搜索到Kubernetes的Dashboard，进入详情页面，可以看到Dashboard的ID为13105，我们可以通过这个ID来导入Dashboard。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-k8s-dashboard.jpg" alt="k8s-prometheus-grafana-k8s-dashboard"></p>
<p>安装完成后，我们可以看到Dashboard的信息</p>
<p><img src="/post/docker/k8s-prometheus-grafana-k8s-info.jpg" alt="k8s-prometheus-grafana-k8s-info"></p>
<h3 id="DevOpsProdigy-KubeGraf插件的使用"><a href="#DevOpsProdigy-KubeGraf插件的使用" class="headerlink" title="DevOpsProdigy KubeGraf插件的使用"></a>DevOpsProdigy KubeGraf插件的使用</h3><p>除了直接导入Dashboard，我们还可以通过安装插件的方式获得，在侧边栏中点击Administartion -&gt; Plugins，可以看到已经安装的插件，点击右上角的[Install]按钮，可以看到插件列表，我们可以在这里搜索到我们需要的插件。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-plugins.jpg" alt="k8s-prometheus-grafana-plugins"></p>
<p>官方也提供了一些插件，我们可以在<a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/plugins?utm_source=grafana_plugin_list">官方插件列表</a>中找到需要的插件。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-plugins-list.jpg" alt="k8s-prometheus-grafana-plugins-list"></p>
<p>Kubernetes相关的插件：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/plugins/grafana-kubernetes-app">grafana-kubernetes-app</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/plugins/devopsprodigy-kubegraf-app">devopsprodigy-kubegraf-app</a></li>
</ul>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://grafana.com/grafana/plugins/devopsprodigy-kubegraf-app">DevOpsProdigy KubeGraf</a> 是一个非常优秀的 Grafana Kubernetes 插件，是 Grafana 官方的 Kubernetes 插件的升级版本，该插件可以用来可视化和分析 Kubernetes 集群的性能，通过各种图形直观的展示了 Kubernetes 集群的主要服务的指标和特征，还可以用于检查应用程序的生命周期和错误日志。</p>
<p>我们可以通过安装插件的方式来安装这个插件，也可以通过导入Dashboard的方式来安装这个插件。</p>
<p><img src="/post/docker/k8s-prometheus-grafana-plugins-kubegraf.jpg" alt="k8s-prometheus-grafana-plugins-kubegraf"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入grafana容器内部执行安装</span></span><br><span class="line">$ kubectl -n monitor <span class="built_in">exec</span> -ti grafana-84f769d885-9qjrc -- bash</span><br><span class="line">grafana-84f769d885-9qjrc:/usr/share/grafana$ grafana cli plugins install devopsprodigy-kubegraf-app 1.5.2</span><br><span class="line">✔ Plugin devopsprodigy-kubegraf-app v1.5.2 already installed.</span><br><span class="line"></span><br><span class="line">Please restart Grafana after installing or removing plugins. Refer to Grafana documentation <span class="keyword">for</span> instructions <span class="keyword">if</span> necessary.</span><br><span class="line"></span><br><span class="line">grafana-84f769d885-9qjrc:/usr/share/grafana$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重建pod生效</span></span><br><span class="line">$ kubectl -n monitor delete po grafana-594f447d6c-jmjsw</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个插件已经被废弃了，以下为之前的安装方式，现在已经不适用了。</p>
</blockquote>
<p>登录grafana界面，在 Plugins 中找到安装的插件，点击插件进入插件详情页面，点击 [Enable]按钮启用插件，点击 <code>Set up your first k8s-cluster</code> 创建一个新的 Kubernetes 集群:</p>
<ul>
<li>Name：test-k8s</li>
<li>URL：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.default/">https://kubernetes.default:443</a></li>
<li>Access：使用默认的Server(default)</li>
<li>Skip TLS Verify：勾选，跳过证书合法性校验</li>
<li>Auth：勾选TLS Client Auth以及With CA Cert，勾选后会下面有三块证书内容需要填写，内容均来自<code>~/.kube/config</code>文件，需要对文件中的内容做一次base64 解码<ul>
<li>CA Cert：使用config文件中的<code>certificate-authority-data</code>对应的内容</li>
<li>Client Cert：使用config文件中的<code>client-certificate-data</code>对应的内容</li>
<li>Client Key：使用config文件中的<code>client-key-data</code>对应的内容</li>
</ul>
</li>
</ul>
<blockquote>
<p>面板没有数据怎么办？</p>
<ul>
<li>DaemonSet<br>label_values(kube_pod_info{namespace&#x3D;”$namespace”,pod&#x3D;~”$daemonset-.*”},pod)</li>
<li>Deployment<br>label_values(kube_pod_info{namespace&#x3D;”$namespace”,pod&#x3D;~”$deployment-.*”},pod)</li>
<li>Pod<br>label_values(kube_pod_info{namespace&#x3D;”$namespace”},pod)</li>
</ul>
</blockquote>
<h3 id="自定义监控面板"><a href="#自定义监控面板" class="headerlink" title="自定义监控面板"></a>自定义监控面板</h3><p>通用的监控需求基本上都可以使用第三方的Dashboard来解决，对于业务应用自己实现的指标的监控面板，则需要我们手动进行创建。</p>
<p>点击[+]按钮，选择New Dashboard，进入新建Dashboard页面</p>
<p><img src="/post/docker/k8s-prometheus-grafana-new-dashboard.jpg" alt="k8s-prometheus-grafana-new-dashboard"></p>
<p>点击[Add visualizations]按钮，创建一个新的监控面板</p>
<p><img src="/post/docker/k8s-prometheus-grafana-new-panel.jpg" alt="k8s-prometheus-grafana-new-panel"></p>
<p>选择数据源，这里我们选择Prometheus</p>
<p><img src="/post/docker/k8s-prometheus-grafana-new-panel-data-source.jpg" alt="k8s-prometheus-grafana-new-panel-data-source"></p>
<p>然后就可以开始创建监控面板了，这里我们创建一个监控节点CPU使用率的监控面板。</p>
<p>如何根据字段过滤，实现联动效果？比如想实现根据集群节点名称进行过滤，可以通过如下方式：</p>
<ol>
<li><p>首先我们先apply监控面板<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-apply.jpg" alt="k8s-prometheus-grafana-new-panel-apply"></p>
</li>
<li><p>点击右上角的Edit按钮，进入编辑页面，选择Variables<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-variables.jpg" alt="k8s-prometheus-grafana-new-panel-variables"></p>
</li>
<li><p>点击Add Variable，添加一个变量node<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-variables-add.jpg" alt="k8s-prometheus-grafana-new-panel-variables-add"></p>
</li>
<li><p>填写变量的信息</p>
<ul>
<li>Name：node</li>
<li>Label：选择节点</li>
<li>Data Source：Prometheus</li>
<li>Query：<ul>
<li>Query type：Label values</li>
<li>Label: node</li>
<li>Metrics：kube_node_info</li>
</ul>
</li>
</ul>
<p> <img src="/post/docker/k8s-prometheus-grafana-new-panel-variables-info.jpg" alt="k8s-prometheus-grafana-new-panel-variables-info"></p>
</li>
<li><p>可以在页面下方的<code>Preview of values</code>查看到当前变量的可选值，点击Apply按钮保存变量<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-variables-preview.jpg" alt="k8s-prometheus-grafana-new-panel-variables-preview"></p>
</li>
<li><p>可以看到变量已经添加成功了<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-variables-success.jpg" alt="k8s-prometheus-grafana-new-panel-variables-success"></p>
</li>
<li><p>面板上方的变量选择框中，可以看到我们刚刚添加的变量<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-variables-select.jpg" alt="k8s-prometheus-grafana-new-panel-variables-select"></p>
</li>
<li><p>我们修改panel的Metrics，$node和变量名字保持一致，意思为自动读取当前设置的节点的名字</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load1&#123;instance=~<span class="string">&quot;<span class="variable">$node</span>&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p> <img src="/post/docker/k8s-prometheus-grafana-new-panel-metrics.jpg" alt="k8s-prometheus-grafana-new-panel-metrics"></p>
</li>
<li><p>点击Apply按钮保存面板，可以看到面板已经有数据了<br> <img src="/post/docker/k8s-prometheus-grafana-new-panel-metrics-success.jpg" alt="k8s-prometheus-grafana-new-panel-metrics-success"></p>
</li>
<li><p>再添加一个面板，使用如下的表达式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100-avg(irate(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>,instance=~<span class="string">&quot;<span class="variable">$node</span>&quot;</span>&#125;[5m])) by (instance)*100</span><br></pre></td></tr></table></figure>
<p><img src="/post/docker/k8s-prometheus-grafana-new-panel-metrics-cpu.jpg" alt="k8s-prometheus-grafana-new-panel-metrics-cpu"></p>
</li>
</ol>
<h1 id="Metrics指标类型与PromQL"><a href="#Metrics指标类型与PromQL" class="headerlink" title="Metrics指标类型与PromQL"></a>Metrics指标类型与PromQL</h1><p>TSDB的样本分布示意图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line">│   . . . . . . . . . . . . . . . . .   . .   node_cpu&#123;cpu=<span class="string">&quot;cpu0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;</span><br><span class="line">│     . . . . . . . . . . . . . . . . . . .   node_cpu&#123;cpu=<span class="string">&quot;cpu0&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125;</span><br><span class="line">│     . . . . . . . . . .   . . . . . . . .   node_load1&#123;&#125;</span><br><span class="line">│     . . . . . . . . . . . . . . . .   . .   node_cpu_seconds_total&#123;...&#125;</span><br><span class="line">v</span><br><span class="line">  &lt;------------------ 时间 ----------------&gt;</span><br></pre></td></tr></table></figure>

<p>Prometheus的监控指标分为四种类型：</p>
<ul>
<li>Counter（计数器）<ul>
<li>性质：表示单调递增的计数，通常用于表示事件发生的次数。</li>
<li>示例：HTTP请求数、任务启动次数等。node_cpu_seconds_total、http_requests_total、node_network_receive_bytes_total</li>
<li>用途：统计系统运行以来的总次数，如http请求总数、系统启动次数等</li>
<li>特性：只增不减，除非系统发生重置，Prometheus重启后会重置所有的Counter类型的指标</li>
</ul>
</li>
<li>Gauge（仪表盘）<ul>
<li>性质：表示单个数值的度量值，通常用于表示系统的当前状态。也可以说表示可任意上升或下降的数值，用于测量瞬时值。</li>
<li>示例：node_memory_MemAvailable_bytes、node_load1、node_cpu_seconds_total</li>
<li>用途：反应系统的当前状态，如内存使用率、CPU利用率等。memory_usage_bytes、node_load1</li>
<li>特性：可增可减，表示一个瞬时值，常见的监控指标，如node_memory_MemAvailable_bytes、node_load1都是Gauge类型的监控指标</li>
</ul>
</li>
<li>Histogram（直方图）<ul>
<li>性质：表示一组数据的分布情况，通常用于统计和分析数据的分布情况。</li>
<li>示例：请求持续时间、文件大小等。prometheus_http_request_duration_seconds_bucket</li>
<li>用途：统计和分析数据的分布情况，如http请求的响应时间分布情况</li>
<li>特性：通过分桶(bucket)和累积计数(cumulative count)表示一组数据的分布情况，常见的监控指标，如prometheus_http_request_duration_seconds_bucket都是Histogram类型的监控指标</li>
</ul>
</li>
<li>Summary（摘要）<ul>
<li>性质：与直方图类似，用于观察和分析样本值的分布情况，但更适用于长时间运行的服务。通常用于统计和分析数据的分布情况。</li>
<li>示例：请求持续时间、文件大小等。http_request_duration_seconds</li>
<li>用途：统计和分析数据的分布情况，如http请求的响应时间分布情况</li>
<li>特性：通过样本值的分位数表示一组数据的分布情况，常见的监控指标，如http_request_duration_seconds都是Summary类型的监控指标</li>
</ul>
</li>
</ul>
<h2 id="Guage类型"><a href="#Guage类型" class="headerlink" title="Guage类型"></a>Guage类型</h2><p>最常用类型的监控指标，如node_memory_MemAvailable_bytes、node_load1都是Gauge类型的监控指标。</p>
<p>Gauge类型的指标侧重于反应系统的当前状态。</p>
<ul>
<li>这类指标的样本数据可增可减。</li>
<li>常见指标如：node_memory_MemAvailable_bytes（可用内存大小）、node_load1（系统平均负载）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n monitor get po -o wide | grep k8s-master</span><br><span class="line">node-exporter-bmv4m                   1/1     Running   0          6d22h   192.168.100.1   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ curl -s 192.168.100.1:9100/metrics | grep node_load1</span><br><span class="line"><span class="comment"># HELP node_load1 1m load average.</span></span><br><span class="line"><span class="comment"># TYPE node_load1 gauge</span></span><br><span class="line">node_load1 0.15</span><br><span class="line"><span class="comment"># HELP node_load15 15m load average.</span></span><br><span class="line"><span class="comment"># TYPE node_load15 gauge</span></span><br><span class="line">node_load15 0.31</span><br></pre></td></tr></table></figure>

<p>Guage类型的数据，通常直接查询就会有比较直观的业务含义，比如：</p>
<ul>
<li>node_load5</li>
<li>node_memory_MemAvailable_bytes</li>
</ul>
<p>我们也会对这类数据做简单的处理，比如：</p>
<ul>
<li>过滤其中某些节点</li>
<li>对指标进行数学运算</li>
</ul>
<p>这就是PromQL提供的能力，可以对收集到的数据做聚合、计算等处理。</p>
<p>PromQL（ Prometheus Query Language ）是Prometheus自定义的一套强大的数据查询语言，除了使用监控指标作为查询关键字以为，还内置了大量的函数，帮助用户进一步对时序数据进行处理。</p>
<p>比如以下几种：</p>
<ul>
<li><p>只显示k8s-master节点的平均负载</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load1&#123;instance=<span class="string">&quot;k8s-master&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示除了k8s-master节点外的其他节点的平均负载</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load1&#123;instance!=<span class="string">&quot;k8s-master&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示过去一段时间内的样本数据</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load1[5m]</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用系统方法对数据进行处理</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avg(node_cpu_seconds_total&#123;mode=<span class="string">&quot;system&quot;</span>, instance=<span class="string">&quot;k8s-master&quot;</span>&#125;) by (instance)</span><br></pre></td></tr></table></figure>
</li>
<li><p>正则匹配</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_load1&#123;instance=~<span class="string">&quot;k8s-master|k8s-slave1&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群各节点系统内存使用率</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes))/node_memory_MemTotal_bytes)*100</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Counter类型："><a href="#Counter类型：" class="headerlink" title="Counter类型："></a>Counter类型：</h2><p>Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。常见的监控指标，如http_requests_total，node_cpu_seconds_total都是Counter类型的监控指标。</p>
<p>通常计数器类型的指标，名称后面都以<code>_total</code>结尾。我们通过理解CPU利用率的PromQL表达式来讲解Counter指标类型的使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s 192.168.100.1:9100/metrics | grep node_cpu_seconds_total</span><br><span class="line"><span class="comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class="line"><span class="comment"># TYPE node_cpu_seconds_total counter</span></span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125; 596447.77</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;iowait&quot;</span>&#125; 70.54</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;irq&quot;</span>&#125; 5690.25</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;nice&quot;</span>&#125; 24.83</span><br><span class="line">node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;softirq&quot;</span>&#125; 3159.72</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>我们通过一个示例来说明Counter类型的指标如何使用以及PromQL的使用。 这个例子是计算各节点CPU的平均使用率表达式，具体如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1- <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[2m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;&#125;[2m])) by (instance)) * 100</span><br></pre></td></tr></table></figure>

<p>接下来我们来分析一下这个表达式：</p>
<p><code>node_cpu_seconds_total</code>的指标含义是统计系统运行以来，CPU资源分配的时间总数，单位为秒，是累加的值。</p>
<p>我们在Prometheus中查询这个指标，可以看到很多结果，显示的是所有节点、所有CPU核心、在各种工作模式下分配的时间总和。</p>
<p>其中mode的值和我们平常在系统中执行<code>top</code>命令看到的CPU显示的信息一致，每个mode对应的含义如下：</p>
<ul>
<li><code>user</code>(us)  表示用户态空间或者说是用户进程(running user space processes)使用CPU所耗费的时间。这是日常我们部署的应用所在的层面，最常见常用。</li>
<li><code>system</code>(sy)  表示内核态层级使用CPU所耗费的时间。分配内存、IO操作、创建子进程……都是内核操作。这也表明，当IO操作频繁时，System参数会很高。</li>
<li><code>steal</code>(st)  当运行在虚拟化环境中，花费在其它 OS 中的时间（基于虚拟机监视器 hypervisor 的调度）；可以理解成由于虚拟机调度器将 cpu 时间用于其它 OS 了，故当前 OS 无法使用 CPU 的时间。</li>
<li><code>softirq</code>(si)  从系统启动开始，累计到当前时刻，软中断时间</li>
<li><code>irq</code>(hi)  从系统启动开始，累计到当前时刻，硬中断时间</li>
<li><code>nice</code>(ni)  从系统启动开始，累计到当前时刻， 低优先级(低优先级意味着进程 nice 值小于 0)用户态的进程所占用的CPU时间</li>
<li><code>iowait</code>(wa)  从系统启动开始，累计到当前时刻，IO等待时间</li>
<li><code>idle</code>(id)  从系统启动开始，累计到当前时刻，除IO等待时间以外的其它等待时间，亦即空闲时间</li>
</ul>
<p>我们通过指标拿到的各核心cpu分配的总时长数据，都是瞬时的数据，如何转换成 CPU的利用率？</p>
<p>先来考虑如何我们如何计算CPU利用率，假如我的k8s-master节点是4核CPU，我们来考虑如下场景：</p>
<ol>
<li>过去60秒内每个CPU核心处于idle空闲状态的时长，假如分别为 :<ul>
<li>cpu0：20s</li>
<li>cpu1：30s</li>
<li>cpu2：50s</li>
<li>cpu3：40s</li>
</ul>
</li>
<li>则四个核心总共可分配的时长是 4*60&#x3D;240s</li>
<li>实际空闲状态的总时长为20+30+50+40&#x3D;140s</li>
<li>那么我们可以计算出过去1分钟k8s-master节点的CPU利用率为 (1- 140&#x2F;240) * 100 &#x3D; 41.7%</li>
</ol>
<p>因此，我们只需要使用PromQL取出上述过程中的值即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 过滤出当前时间点idle的时长</span></span><br><span class="line">node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用[1m]取出1分钟区间内的样本值,注意，1m区间要大于prometheus设置的抓取周期，此处会将周期内所以的样本值取出</span></span><br><span class="line">node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用increase方法，获取该区间内idle状态的增量值,即1分钟内，mode=&quot;idle&quot;状态增加的时长</span></span><br><span class="line">increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于是多个cpu核心，因此需要做累加，使用sum函数</span></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于是多台机器，因此，需要按照instance的值进行分组累加，使用by关键字做分组,这样就获得了1分钟内，每个节点上 所有CPU核心idle状态的增量时长，即前面示例中的”20+30+50+40=140s“</span></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])) by (instance)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去掉mode=idle的过滤条件，即可获取1分钟内，所有状态的cpu获得的增量总时长，即4*60=240s</span></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;&#125;[1m])) by (instance)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最终的语句</span></span><br><span class="line">(1- <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;&#125;[1m])) by (instance)) * 100</span><br></pre></td></tr></table></figure>

<p>除此之外，还会经常看到avg,irate和rate方法的使用：</p>
<p><code>irate()</code> 是基于最后两个数据点计算一个时序指标在一个范围内的每秒递增率 ，举个例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1min内，k8s-master节点的idle状态的cpu分配时长增量值</span></span><br><span class="line">increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;k8s-master&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])</span><br><span class="line"></span><br><span class="line">&#123;cpu=<span class="string">&quot;0&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	56.5</span><br><span class="line">&#123;cpu=<span class="string">&quot;1&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	56.04</span><br><span class="line">&#123;cpu=<span class="string">&quot;2&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	56.6</span><br><span class="line">&#123;cpu=<span class="string">&quot;3&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	56.5</span><br><span class="line"></span><br><span class="line"><span class="comment">#以第一条数据为例，说明过去的1分钟，k8s-master节点的第一个CPU核心，有56.5秒的时长是出于idle状态的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1min内，k8s-master节点的idle状态的cpu分配每秒的速率</span></span><br><span class="line"><span class="comment"># 该值如何计算的？</span></span><br><span class="line"><span class="comment"># irate会取出样本中的最后两个点来作为增长依据，然后做差值计算，并且除以两个样本间的数据时长，也就是说，我们设置2m,5m取出来的值是一样的，因为只会计算最后两个样本差。</span></span><br><span class="line"><span class="comment"># 以第一条数据为例，表示用irate计算出来的结果是，过去的两分钟内，cpu平均每秒钟有0.934秒的时间是处于idle状态的</span></span><br><span class="line">irate(node_cpu_seconds_total&#123;instance=<span class="string">&quot;k8s-master&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])</span><br><span class="line">&#123;cpu=<span class="string">&quot;0&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.934</span><br><span class="line">&#123;cpu=<span class="string">&quot;1&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.932</span><br><span class="line">&#123;cpu=<span class="string">&quot;2&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.933</span><br><span class="line">&#123;cpu=<span class="string">&quot;3&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.936</span><br><span class="line"></span><br><span class="line"><span class="comment"># rate会1min内第一个和最后一个样本值为依据，计算方式和irate保持一致</span></span><br><span class="line">rate(node_cpu_seconds_total&#123;instance=<span class="string">&quot;k8s-master&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])</span><br><span class="line">&#123;cpu=<span class="string">&quot;0&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.933</span><br><span class="line">&#123;cpu=<span class="string">&quot;1&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.940</span><br><span class="line">&#123;cpu=<span class="string">&quot;2&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.935</span><br><span class="line">&#123;cpu=<span class="string">&quot;3&quot;</span>,instance=<span class="string">&quot;k8s-master&quot;</span>,job=<span class="string">&quot;kubernetes-sd-node-exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;	0.937</span><br></pre></td></tr></table></figure>

<p>因此rate的值，相对来讲更平滑，因为计算的是时间段内的平均，更适合于用作告警。</p>
<p>取CPU平均使用率也可以用如下表达式表示：<code>(1 - avg(rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[1m])) by (instance)) * 100</code></p>
<h1 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h1><p>Alertmanager是一个独立的告警模块，主要作用有以下几点：</p>
<ul>
<li>接收Prometheus等客户端发来的警报</li>
<li>通过分组、删除重复等处理，并将它们通过路由发送给正确的接收器；</li>
<li>告警方式可以按照不同的规则发送给不同的模块负责人。Alertmanager支持Email, Slack，等告警方式, 也可以通过webhook接入钉钉等国内IM工具。</li>
</ul>
<p><img src="/post/docker/alertmanager.png" alt="alertmanager"></p>
<p>如果集群主机的内存使用率超过80%，且该现象持续了2分钟？想实现这样的监控告警，如何做？</p>
<p>从上图可得知设置警报和通知的主要步骤是：</p>
<ul>
<li>安装和配置 Alertmanager</li>
<li>配置Prometheus与Alertmanager对话</li>
<li>在Prometheus中创建警报规则</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>alertmanager的安装方式可以参考<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/prometheus/alertmanager#install">官方仓库</a>，但是这里我们使用helm来安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ helm pull prometheus-community/alertmanager</span><br><span class="line">$ tar xf alertmanager-1.7.0.tgz</span><br><span class="line"><span class="comment"># 具体修改内容下面列出</span></span><br><span class="line">$ vim alertmanager/values.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来就是安装环节了</span></span><br><span class="line">$ helm install alertmanager ./alertmanager -n monitor</span><br><span class="line"><span class="comment"># 查看安装的pod</span></span><br><span class="line">$ kubectl -n monitor get po -o wide</span><br></pre></td></tr></table></figure>

<p>修改的values.yaml文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">ingress:</span><br><span class="line">  # 开启ingress</span><br><span class="line">  enabled: true</span><br><span class="line">  className: &quot;&quot;</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: nginx</span><br><span class="line">    # kubernetes.io/tls-acme: &quot;true&quot;</span><br><span class="line">  hosts:</span><br><span class="line">    - host: alertmanager.test.com</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: ImplementationSpecific</span><br><span class="line">  tls: []</span><br><span class="line">  ......</span><br><span class="line"># 数据可以保存，这里只需要指定sc的名称即可</span><br><span class="line">persistence:</span><br><span class="line">  enabled: true</span><br><span class="line">  ## Persistent Volume Storage Class</span><br><span class="line">  ## If defined, storageClassName: &lt;storageClass&gt;</span><br><span class="line">  ## If set to &quot;-&quot;, storageClassName: &quot;&quot;, which disables dynamic provisioning</span><br><span class="line">  ## If undefined (the default) or set to null, no storageClassName spec is</span><br><span class="line">  ## set, choosing the default provisioner.</span><br><span class="line">  ##</span><br><span class="line">  storageClass: &quot;nfs-client&quot;</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  size: 50Mi</span><br><span class="line">  ......</span><br><span class="line"># alertmanager的配置文件</span><br><span class="line">config:</span><br><span class="line">  enabled: true</span><br><span class="line">  global:</span><br><span class="line">    # slack_api_url: &#x27;&#x27;</span><br><span class="line">    # 当alertmanager持续多长时间未接收到告警后标记告警状态为 resolved</span><br><span class="line">    resolve_timeout: 5m</span><br><span class="line">    # 配置邮件发送信息</span><br><span class="line">    smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span><br><span class="line">    smtp_from: &#x27;ganchangde@163.com&#x27;</span><br><span class="line">    smtp_auth_username: &#x27;ganchangde@163.com&#x27;</span><br><span class="line">    smtp_auth_password: &#x27;xxxxxxxxxx&#x27;</span><br><span class="line">    smtp_require_tls: false</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">    - &#x27;/etc/alertmanager/*.tmpl&#x27;</span><br><span class="line"></span><br><span class="line">  # 配置告警接收者的信息</span><br><span class="line">  receivers:</span><br><span class="line">    - name: default-receiver</span><br><span class="line">      # slack_configs:</span><br><span class="line">      #  - channel: &#x27;@you&#x27;</span><br><span class="line">      #    send_resolved: true</span><br><span class="line">      email_configs:</span><br><span class="line">        - to: &#x27;changde.gan@iluvatar.com&#x27;</span><br><span class="line">          send_resolved: true</span><br><span class="line"></span><br><span class="line">  # 所有报警信息进入后的根路由，用来设置报警的分发策略</span><br><span class="line">  route:</span><br><span class="line">    # 接收到的报警信息里面有许多alertname=NodeLoadHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span><br><span class="line">    group_by: [&#x27;alertname&#x27;]</span><br><span class="line">    # 当一个新的报警分组被创建后，需要等待至少 group_wait 时间来初始化通知，如果在等待时间内当前group接收到了新的告警，这些告警将会合并为一个通知向receiver发送</span><br><span class="line">    group_wait: 30s</span><br><span class="line">    # 相同的group发送告警通知的时间间隔</span><br><span class="line">    group_interval: 5m</span><br><span class="line">    # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span><br><span class="line">    receiver: default-receiver</span><br><span class="line">    # 如果一个报警信息已经发送成功了，等待 repeat_interval 时间来重新发送</span><br><span class="line">    repeat_interval: 3h</span><br><span class="line">    # 上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。</span><br><span class="line">    routes:</span><br><span class="line">      - &#123;&#125;</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>

<p>其中config字段中的内容是alertmanager的主要配置，它的作用如下：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://prometheus.io/docs/alerting/configuration/#configuration-file">global</a>: 全局配置，包括报警解决后的超时时间、SMTP 相关配置、各种渠道通知的 API 地址等等。</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://prometheus.io/docs/alerting/configuration/#route">route</a>: 用来设置报警的分发策略，它是一个树状结构，按照深度优先从左向右的顺序进行匹配。</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://prometheus.io/docs/alerting/configuration/#receiver">receivers</a>: 配置告警消息接受者信息，例如常用的 email、wechat、slack、webhook 等消息通知方式。</li>
</ul>
<p>当alertmanager接收到一条新的alert时，会先根据group_by为其确定一个聚合组group，然后等待group_wait时间，如果在此期间接收到同一group的其他alert，则这些alert会被合并，然后再发送（alertmanager发送消息单位是group）。此参数的作用是防止短时间内出现大量告警的情况下，接收者被告警淹没。</p>
<p>在该组的alert第一次被发送后，该组会进入睡眠&#x2F;唤醒周期，睡眠周期将持续group_interval时间，在睡眠状态下该group不会进行任何发送告警的操作（但会插入&#x2F;更新(根据fingerprint)group中的内容），睡眠结束后进入唤醒状态，然后检查是否需要发送新的alert或者重复已发送的alert(resolved类型的alert在发送完后会从group中剔除)。这就是group_interval的作用。</p>
<p>聚合组在每次唤醒才会检查上一次发送alert是否已经超过repeat_interval时间，如果超过则再次发送该告警。</p>
<h2 id="配置Prometheus与Alertmanager对话"><a href="#配置Prometheus与Alertmanager对话" class="headerlink" title="配置Prometheus与Alertmanager对话"></a>配置Prometheus与Alertmanager对话</h2><p><img src="/post/docker/alertmanager.png" alt="alertmanager"></p>
<p>是否告警是由Prometheus进行判断的，若有告警产生，Prometheus会将告警push到Alertmanager，因此，需要在Prometheus端配置alertmanager的地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n monitor edit configmap prometheus-config</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">    <span class="comment"># my global config</span></span><br><span class="line">    global:</span><br><span class="line">      scrape_interval: 30s</span><br><span class="line">      evaluation_interval: 30s</span><br><span class="line">      <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Alertmanager configuration</span></span><br><span class="line">    alerting:</span><br><span class="line">      alertmanagers:</span><br><span class="line">      - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - alertmanager:9093</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">$ kubectl -n monitor <span class="built_in">exec</span> prometheus-5bc5966ff8-f84vx -- <span class="built_in">cat</span> /etc/prometheus/prometheus.yml</span><br><span class="line">$ curl -XPOST 10.244.0.26:9090/-/reload</span><br></pre></td></tr></table></figure>

<p>到这里已经安装了alertmanager，也配置了Prometheus与Alertmanager对话，接下来就是配置告警规则了。</p>
<h2 id="配置告警规则"><a href="#配置告警规则" class="headerlink" title="配置告警规则"></a>配置告警规则</h2><p>目前Prometheus与Alertmanager已经连通，接下来我们可以针对收集到的各类指标配置报警规则，一旦满足报警规则的设置，则Prometheus将报警信息推送给Alertmanager，进而转发到我们配置的邮件中。</p>
<p>在哪里配置？同样是在prometheus-configmap中配置。我们配置报警文件的路径，然后使用configmap的方式，将报警规则文件挂载到prometheus容器内部。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ kuectl -n monitor edit configmap prometheus-config</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">    <span class="comment"># Load rules once and periodically evaluate them according to the global  &#x27;evaluation_interval&#x27;.</span></span><br><span class="line">    rule_files:</span><br><span class="line">      <span class="comment"># 配置告警规则文件</span></span><br><span class="line">      - /etc/prometheus/alert_rules.yml</span><br><span class="line">......</span><br><span class="line">  alert_rules.yml: |</span><br><span class="line">    <span class="built_in">groups</span>:</span><br><span class="line">    - name: node_metrics</span><br><span class="line">      rules:</span><br><span class="line">      - alert: NodeLoad</span><br><span class="line">        <span class="built_in">expr</span>: node_load15 &lt; 1</span><br><span class="line">        <span class="keyword">for</span>: 2m</span><br><span class="line">        annotations:</span><br><span class="line">          summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Low node load detected&quot;</span></span><br><span class="line">          description: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: node load is below 1 (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;&quot;</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">$ kubectl -n monitor <span class="built_in">exec</span> prometheus-5bc5966ff8-f84vx -- <span class="built_in">cat</span> /etc/prometheus/alert_rules.yml</span><br><span class="line"><span class="comment"># 重载配置之后就可以进入Prometheus的web界面查看告警规则了</span></span><br><span class="line">$ curl -XPOST 10.244.0.26:9090/-/reload</span><br></pre></td></tr></table></figure>

<p>告警规则的几个要素：</p>
<ul>
<li><code>group.name</code>：告警分组的名称，一个组下可以配置一类告警规则，比如都是物理节点相关的告警</li>
<li><code>alert</code>：告警规则的名称</li>
<li><code>expr</code>：是用于进行报警规则 PromQL 查询语句，expr通常是布尔表达式，可以让Prometheus根据计算的指标值做 true or false 的判断</li>
<li><code>for</code>：评估等待时间（Pending Duration），用于表示只有当触发条件持续一段时间后才发送告警，在等待期间新产生的告警状态为<code>pending</code>，屏蔽掉瞬时的问题，把焦点放在真正有持续影响的问题上</li>
<li><code>labels</code>：自定义标签，允许用户指定额外的标签列表，把它们附加在告警上，可以用于后面做路由判断，通知到不同的终端，通常被用于添加告警级别的标签</li>
<li><code>annotations</code>：指定了另一组标签，它们不被当做告警实例的身份标识，它们经常用于存储一些额外的信息，用于报警信息的展示之类的</li>
</ul>
<p>规则配置中，支持模板的方式，其中：</p>
<ul>
<li><code>&#123;&#123;$labels&#125;&#125;</code>可以获取当前指标的所有标签，支持<code>&#123;&#123;$labels.instance&#125;&#125;</code>或者<code>&#123;&#123;$labels.job&#125;&#125;</code>这种形式</li>
<li><code>&#123;&#123; $value &#125;&#125;</code>可以获取当前计算出的指标值</li>
</ul>
<p>一个报警信息在生命周期内有下面3种状态：</p>
<ul>
<li><code>inactive</code>: 表示当前报警信息处于非活动状态，即不满足报警条件</li>
<li><code>pending</code>: 表示在设置的阈值时间范围内被激活了，即满足报警条件，但是还在观察期内</li>
<li><code>firing</code>: 表示超过设置的阈值时间被激活了，即满足报警条件，且报警触发时间超过了观察期，会发送到Alertmanager端</li>
</ul>
<p>对于已经 <code>pending</code> 或者 <code>firing</code> 的告警，Prometheus 也会将它们存储到时间序列<code>ALERTS&#123;&#125;</code>中。当然我们也可以通过表达式去查询告警实例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALERTS&#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义webhook实现告警消息的推送"><a href="#自定义webhook实现告警消息的推送" class="headerlink" title="自定义webhook实现告警消息的推送"></a>自定义webhook实现告警消息的推送</h2><p>目前官方内置的第三方通知集成包括：邮件、 即时通讯软件（如Slack、Hipchat）、移动应用消息推送(如Pushover)和自动化运维工具（例如：Pagerduty、Opsgenie、Victorops）。可以在alertmanager的管理界面中查看到。</p>
<p>每一个receiver具有一个全局唯一的名称，并且对应一个或者多个通知方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">name: &lt;string&gt;</span><br><span class="line">email_configs:</span><br><span class="line">  [ - &lt;email_config&gt;, ... ]</span><br><span class="line">hipchat_configs:</span><br><span class="line">  [ - &lt;hipchat_config&gt;, ... ]</span><br><span class="line">slack_configs:</span><br><span class="line">  [ - &lt;slack_config&gt;, ... ]</span><br><span class="line">opsgenie_configs:</span><br><span class="line">  [ - &lt;opsgenie_config&gt;, ... ]</span><br><span class="line">webhook_configs:</span><br><span class="line">  [ - &lt;webhook_config&gt;, ... ]</span><br></pre></td></tr></table></figure>

<p>如果想实现告警消息推送给企业常用的即时聊天工具，如钉钉或者企业微信，如何配置？</p>
<p>Alertmanager的通知方式中还可以支持Webhook，通过这种方式开发者可以实现更多个性化的扩展支持，配置的格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 警报接收者</span></span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;demo-webhook&#x27;</span></span><br><span class="line">  webhook_configs:</span><br><span class="line">  - send_resolved: <span class="literal">true</span></span><br><span class="line">    url: http://demo-webhook/alert/send</span><br></pre></td></tr></table></figure>

<p>当我们配置了上述webhook地址，则当告警路由到<code>alertmanager</code>时，alertmanager端会向webhook地址推送POST请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X POST -d<span class="string">&quot;<span class="variable">$demoAlerts</span>&quot;</span>  http://demo-webhook/alert/send</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$demoAlerts</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;4&quot;</span>,</span><br><span class="line">  <span class="string">&quot;groupKey&quot;</span>: &lt;string&gt;, alerts (e.g. to deduplicate) ,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;&lt;resolved|firing&gt;&quot;</span>, </span><br><span class="line">  <span class="string">&quot;receiver&quot;</span>: &lt;string&gt;, </span><br><span class="line">  <span class="string">&quot;groupLabels&quot;</span>: &lt;object&gt;, </span><br><span class="line">  <span class="string">&quot;commonLabels&quot;</span>: &lt;object&gt;, </span><br><span class="line">  <span class="string">&quot;commonAnnotations&quot;</span>: &lt;object&gt;, </span><br><span class="line">  <span class="string">&quot;externalURL&quot;</span>: &lt;string&gt;, // backlink to the Alertmanager. </span><br><span class="line">  <span class="string">&quot;alerts&quot;</span>: </span><br><span class="line">   [&#123; </span><br><span class="line">     <span class="string">&quot;labels&quot;</span>: &lt;object&gt;, </span><br><span class="line">      <span class="string">&quot;annotations&quot;</span>: &lt;object&gt;, </span><br><span class="line">      <span class="string">&quot;startsAt&quot;</span>: <span class="string">&quot;&lt;rfc3339&gt;&quot;</span>, </span><br><span class="line">      <span class="string">&quot;endsAt&quot;</span>: <span class="string">&quot;&lt;rfc3339&gt;&quot;</span> </span><br><span class="line">   &#125;] </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>因此，假如我们想把报警消息自动推送到钉钉群聊，只需要完成3个步骤：</p>
<ul>
<li>创建一个能给钉钉群聊发送消息的钉钉机器人</li>
<li>实现一个数据解析的容器，将Alertmanager传过来的数据做解析，成为钉钉机器人能够识别的格式，然后调用钉钉机器人的API，实现消息推送</li>
<li>配置alertmanager的receiver为webhook地址</li>
</ul>
<p>首先，我们要想给钉钉群聊发送消息，需要创建一个钉钉机器人，按照以下步骤创建。</p>
<ol>
<li>登录钉钉群</li>
<li>点击群设置</li>
<li>选择机器人管理</li>
<li>然后选择自定义机器人</li>
<li>创建一个机器人</li>
<li>选择自定义关键词</li>
<li>然后输入关键词</li>
<li>点击完成，即可创建一个机器人</li>
<li>创建完成后，会生成一个webhook地址，这个地址就是钉钉机器人的访问地址，后面我们会使用到</li>
</ol>
<p>接下来，我们试一下钉钉机器人的API，看看如何给钉钉群聊发送消息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">&#x27;https://oapi.dingtalk.com/robot/send?access_token=f628f749a7ad70e86ca7bcb68658d0ce5af7c201ce8ce32acaece4c592364ca9&#x27;</span> \</span><br><span class="line">   -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">   -d <span class="string">&#x27;&#123;&quot;msgtype&quot;: &quot;text&quot;,&quot;text&quot;: &#123;&quot;content&quot;: &quot;我就是我, 是不一样的烟火&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>再然后我们就需要一个容器，来实现Alertmanager传过来的数据解析，然后调用钉钉机器人的API，实现消息推送。这里我们选择使用项目：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://gitee.com/agagin/prometheus-webhook-dingtalk">prometheus-webhook-dingtalk</a></p>
<p>项目也有docker镜像，镜像地址：<code>timonwong/prometheus-webhook-dingtalk:master</code></p>
<p>这个项目的二进制运行方式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./prometheus-webhook-dingtalk --config.file=config.yml</span><br></pre></td></tr></table></figure>

<p>假如使用如下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">targets:</span><br><span class="line">  webhook_dev:</span><br><span class="line">    url: https://oapi.dingtalk.com/robot/send?access_token=f33c539fa1012e0b3500f04ea98fb89468829ed324699d67ecd2f177a1dcc0c2</span><br><span class="line">  webhook_ops:</span><br><span class="line">    url: https://oapi.dingtalk.com/robot/send?access_token=4778abd23dbdbaf66fc6f413e6ab9c0103a039b0054201344a22a5692cdcc54e</span><br></pre></td></tr></table></figure>

<p>则prometheus-webhook-dingtalk启动后会自动支持如下API的POST访问：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://locahost:8060/dingtalk/webhook_dev/send</span><br><span class="line">http://localhost:8060/dingtalk/webhook_ops/send</span><br></pre></td></tr></table></figure>

<p>这样可以使用一个prometheus-webhook-dingtalk来实现多个钉钉群的webhook地址</p>
<p>那么我们来部署一下prometheus-webhook-dingtalk，从项目的Dockerfile可以得知需要注意以下几点：</p>
<ul>
<li>默认使用配置文件<code>/etc/prometheus-webhook-dingtalk/config.yml</code>，可以通过configmap挂载</li>
<li>该目录下还有模板文件，因此需要使用subpath的方式挂载</li>
<li>部署Service，作为Alertmanager的默认访问，服务端口默认8060</li>
</ul>
<p>首先准备配置文件的资源清单，通过configmap挂载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> webhook-dingtalk-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config.yml: |</span><br><span class="line">    targets:</span><br><span class="line">      webhook_dev:</span><br><span class="line">        url: https://oapi.dingtalk.com/robot/send?access_token=f33c539fa1012e0b3500f04ea98fb89468829ed324699d67ecd2f177a1dcc0c2</span><br><span class="line">      webhook_ops:</span><br><span class="line">        url: https://oapi.dingtalk.com/robot/send?access_token=4778abd23dbdbaf66fc6f413e6ab9c0103a039b0054201344a22a5692cdcc54e</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: webhook-dingtalk-config</span><br><span class="line">  namespace: monitor</span><br></pre></td></tr></table></figure>

<p>准备Deployment和Service的资源清单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> webhook-dingtalk-deploy.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: webhook-dingtalk</span><br><span class="line">  namespace: monitor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: webhook-dingtalk</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webhook-dingtalk</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: webhook-dingtalk</span><br><span class="line">        image: timonwong/prometheus-webhook-dingtalk:master</span><br><span class="line">        args:</span><br><span class="line">        - <span class="string">&quot;--config.file=/etc/prometheus-webhook-dingtalk/config.yml&quot;</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">&quot;/etc/prometheus-webhook-dingtalk/config.yml&quot;</span></span><br><span class="line">          name: config</span><br><span class="line">          subPath: config.yml</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8060</span><br><span class="line">          name: http</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: webhook-dingtalk-config</span><br><span class="line">          items:</span><br><span class="line">          - key: config.yml</span><br><span class="line">            path: config.yml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: webhook-dingtalk</span><br><span class="line">  namespace: monitor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: webhook-dingtalk</span><br><span class="line">  ports:</span><br><span class="line">  - name: hook</span><br><span class="line">    port: 8060</span><br><span class="line">    targetPort: http</span><br></pre></td></tr></table></figure>

<p>创建资源清单并部署prometheus-webhook-dingtalk：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f webhook-dingtalk-configmap.yaml</span><br><span class="line">$ kubectl apply -f webhook-dingtalk-deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志，可以得知当前的可用webhook日志</span></span><br><span class="line">$ kubectl -n monitor logs -f webhook-dingtalk-54f7d5475f-lwrs8</span><br><span class="line">...</span><br><span class="line">level=info ts=2023-12-11T15:59:27.792Z <span class="built_in">caller</span>=coordinator.go:91 component=configuration file=/etc/prometheus-webhook-dingtalk/config.yml msg=<span class="string">&quot;Completed loading of configuration file&quot;</span></span><br><span class="line">level=info ts=2023-12-11T15:59:27.792Z <span class="built_in">caller</span>=main.go:98 component=configuration msg=<span class="string">&quot;Loading templates&quot;</span> templates=</span><br><span class="line">ts=2023-12-11T15:59:27.890Z <span class="built_in">caller</span>=main.go:114 component=configuration msg=<span class="string">&quot;Webhook urls for prometheus alertmanager&quot;</span> urls=<span class="string">&quot;http://localhost:8060/dingtalk/webhook_dev/send http://localhost:8060/dingtalk/webhook_ops/send&quot;</span></span><br><span class="line">level=info ts=2023-12-11T15:59:27.891Z <span class="built_in">caller</span>=web.go:210 component=web msg=<span class="string">&quot;Start listening for connections&quot;</span> address=:8060</span><br></pre></td></tr></table></figure>

<p>一切准备就绪了，接下来就可以修改Alertmanager路由及webhook配置了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n monitor edit configmap alertmanager</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitor</span><br><span class="line">data:</span><br><span class="line">  config.yml: |-</span><br><span class="line">    global:</span><br><span class="line">      <span class="comment"># 当alertmanager持续多长时间未接收到告警后标记告警状态为 resolved</span></span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      <span class="comment"># 配置邮件发送信息</span></span><br><span class="line">      smtp_smarthost: <span class="string">&#x27;smtp.163.com:25&#x27;</span></span><br><span class="line">      smtp_from: <span class="string">&#x27;ganchangde@163.com&#x27;</span></span><br><span class="line">      smtp_auth_username: <span class="string">&#x27;ganchangde@163.com&#x27;</span></span><br><span class="line">      <span class="comment"># 注意这里不是邮箱密码，是邮箱开启第三方客户端登录后的授权码</span></span><br><span class="line">      smtp_auth_password: <span class="string">&#x27;GXIWNXKMMEVMNHAJ&#x27;</span></span><br><span class="line">      smtp_require_tls: <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 所有报警信息进入后的根路由，用来设置报警的分发策略</span></span><br><span class="line">    route:</span><br><span class="line">      <span class="comment"># 按照告警名称分组</span></span><br><span class="line">      group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">      <span class="comment"># 当一个新的报警分组被创建后，需要等待至少 group_wait 时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span></span><br><span class="line">      group_wait: 30s</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 相同的group之间发送告警通知的时间间隔</span></span><br><span class="line">      group_interval: 30s</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 如果一个报警信息已经发送成功了，等待 repeat_interval 时间来重新发送他们，不同类型告警发送频率需要具体配置</span></span><br><span class="line">      repeat_interval: 1m</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span></span><br><span class="line">      receiver: default</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 路由树，默认继承global中的配置，并且可以在每个子路由上进行覆盖。</span></span><br><span class="line">      routes:</span><br><span class="line">      - &#123;&#125;</span><br><span class="line">    receivers:</span><br><span class="line">    - name: <span class="string">&#x27;default&#x27;</span></span><br><span class="line">      email_configs:</span><br><span class="line">      - to: <span class="string">&#x27;changde.gan@iluvatar.com&#x27;</span></span><br><span class="line">        <span class="comment"># 接受告警恢复的通知</span></span><br><span class="line">        send_resolved: <span class="literal">true</span></span><br><span class="line">      webhook_configs:</span><br><span class="line">      - send_resolved: <span class="literal">true</span></span><br><span class="line">        url: http://webhook-dingtalk:8060/dingtalk/webhook_dev/send</span><br></pre></td></tr></table></figure>

<p>验证钉钉消息是否正常收到。</p>
<h2 id="基于Label的动态告警处理"><a href="#基于Label的动态告警处理" class="headerlink" title="基于Label的动态告警处理"></a>基于Label的动态告警处理</h2><p>真实的场景中，我们往往期望可以给告警设置级别，而且可以实现不同的报警级别可以由不同的receiver接收告警消息。</p>
<p>Alertmanager中路由负责对告警信息进行分组匹配，并向告警接收器发送通知。告警接收器可以通过以下形式进行配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">routes:</span><br><span class="line">- receiver: ops</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  match:</span><br><span class="line">    severity: critical</span><br><span class="line">- receiver: dev</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  match_re:</span><br><span class="line">    severity: normal|middle</span><br><span class="line">receivers:</span><br><span class="line">  - ops</span><br><span class="line">    ...</span><br><span class="line">  - dev</span><br><span class="line">    ...</span><br><span class="line">  - &lt;receiver&gt; ...</span><br></pre></td></tr></table></figure>

<p>因此可以为了更全面的感受报警的逻辑，我们再添加两个报警规则，并且它们通过labels字段打标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">alert_rules.yml: |</span><br><span class="line">  <span class="built_in">groups</span>:</span><br><span class="line">  - name: node_metrics</span><br><span class="line">    rules:</span><br><span class="line">    - alert: NodeLoad</span><br><span class="line">      <span class="built_in">expr</span>: node_load15 &lt; 1</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: normal</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Low node load detected&quot;</span></span><br><span class="line">        description: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: node load is below 1 (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;&quot;</span></span><br><span class="line">    - alert: NodeMemoryUsage</span><br><span class="line">      <span class="built_in">expr</span>: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: High Memory usage detected&quot;</span></span><br><span class="line">        description: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: Memory usage is above 40% (current value is: &#123;&#123; <span class="variable">$value</span> &#125;&#125;&quot;</span></span><br><span class="line">  - name: targets_status</span><br><span class="line">    rules:</span><br><span class="line">    - alert: TargetStatus</span><br><span class="line">      <span class="built_in">expr</span>: up == 0</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: prometheus target down&quot;</span></span><br><span class="line">        description: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;: prometheus target down，job is &#123;&#123;<span class="variable">$labels</span>.job&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们为不同的报警规则设置了不同的标签，如<code>severity: critical</code>，针对规则中的label，来配置alertmanager路由规则，实现转发给不同的接收者。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> alertmanager-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitor</span><br><span class="line">data:</span><br><span class="line">  config.yml: |-</span><br><span class="line">    global:</span><br><span class="line">      <span class="comment"># 当alertmanager持续多长时间未接收到告警后标记告警状态为 resolved</span></span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      <span class="comment"># 配置邮件发送信息</span></span><br><span class="line">      smtp_smarthost: <span class="string">&#x27;smtp.163.com:25&#x27;</span></span><br><span class="line">      smtp_from: <span class="string">&#x27;ganchangde@163.com&#x27;</span></span><br><span class="line">      smtp_auth_username: <span class="string">&#x27;ganchangde@163.com&#x27;</span></span><br><span class="line">      <span class="comment"># 注意这里不是邮箱密码，是邮箱开启第三方客户端登录后的授权码</span></span><br><span class="line">      smtp_auth_password: <span class="string">&#x27;RMAOPQVHKLPYFVHZ&#x27;</span></span><br><span class="line">      smtp_require_tls: <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 所有报警信息进入后的根路由，用来设置报警的分发策略</span></span><br><span class="line">    route:</span><br><span class="line">      <span class="comment"># 按照告警名称分组</span></span><br><span class="line">      group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">      <span class="comment"># 当一个新的报警分组被创建后，需要等待至少 group_wait 时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span></span><br><span class="line">      group_wait: 30s</span><br><span class="line">      <span class="comment"># 相同的group之间发送告警通知的时间间隔</span></span><br><span class="line">      group_interval: 30s</span><br><span class="line">      <span class="comment"># 如果一个报警信息已经发送成功了，等待 repeat_interval 时间来重新发送他们，不同类型告警发送频率需要具体配置</span></span><br><span class="line">      repeat_interval: 1m</span><br><span class="line">      <span class="comment"># 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span></span><br><span class="line">      receiver: default</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 路由树，默认继承global中的配置，并且可以在每个子路由上进行覆盖。</span></span><br><span class="line">      routes:</span><br><span class="line">      - receiver: critical_alerts</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        match:</span><br><span class="line">          severity: critical</span><br><span class="line">      - receiver: normal_alerts</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        match_re:</span><br><span class="line">          severity: normal|middle</span><br><span class="line">    receivers:</span><br><span class="line">    - name: <span class="string">&#x27;default&#x27;</span></span><br><span class="line">      email_configs:</span><br><span class="line">      - to: <span class="string">&#x27;changde.gan@iluvatar.com&#x27;</span></span><br><span class="line">        <span class="comment"># 接受告警恢复的通知</span></span><br><span class="line">        send_resolved: <span class="literal">true</span></span><br><span class="line">    - name: <span class="string">&#x27;critical_alerts&#x27;</span></span><br><span class="line">      webhook_configs:</span><br><span class="line">      - send_resolved: <span class="literal">true</span></span><br><span class="line">        url: http://webhook-dingtalk:8060/dingtalk/webhook_ops/send</span><br><span class="line">    - name: <span class="string">&#x27;normal_alerts&#x27;</span></span><br><span class="line">      webhook_configs:</span><br><span class="line">      - send_resolved: <span class="literal">true</span></span><br><span class="line">        url: http://webhook-dingtalk:8060/dingtalk/webhook_dev/send</span><br></pre></td></tr></table></figure>

<p>再配置一个钉钉机器人，修改webhook-dingtalk的配置，添加webhook_ops的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> webhook-dingtalk-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  config.yml: |</span><br><span class="line">    targets:</span><br><span class="line">      webhook_dev:</span><br><span class="line">        url: https://oapi.dingtalk.com/robot/send?access_token=f628f749a7ad70e86ca7bcb68658d0ce5af7c201ce8ce32acaece4c592364ca9</span><br><span class="line">      webhook_ops:</span><br><span class="line">        url: https://oapi.dingtalk.com/robot/send?access_token=5a68888fbecde75b1832ff024d7374e51f2babd33f1078e5311cdbb8e2c00c3a</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: webhook-dingtalk-config</span><br><span class="line">  namespace: monitor</span><br></pre></td></tr></table></figure>

<p>分别更新Prometheus和Alertmanager配置，查看报警的发送。</p>
<h2 id="抑制和静默"><a href="#抑制和静默" class="headerlink" title="抑制和静默"></a>抑制和静默</h2><p>前面我们知道，告警的<code>group(分组)</code>功能通过把多条告警数据聚合，有效的减少告警的频繁发送。除此之外，Alertmanager还支持<code>Inhibition(抑制)</code>和<code>Silences(静默)</code>，帮助我们抑制或者屏蔽报警。</p>
<h3 id="Inhibition-抑制"><a href="#Inhibition-抑制" class="headerlink" title="Inhibition 抑制"></a>Inhibition 抑制</h3><p>抑制是当出现其它告警的时候压制当前告警的通知，可以有效的防止告警风暴。</p>
<p>比如当机房出现网络故障时，所有服务都将不可用而产生大量服务不可用告警，但这些警告并不能反映真实问题在哪，真正需要发出的应该是网络故障告警。当出现网络故障告警的时候，应当抑制服务不可用告警的通知。</p>
<p>在Alertmanager配置文件中，使用inhibit_rules定义一组告警的抑制规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inhibit_rules:</span><br><span class="line">[ - &lt;inhibit_rule&gt; ... ]</span><br></pre></td></tr></table></figure>

<p>每一条抑制规则的具体配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">target_match:</span><br><span class="line">[ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]</span><br><span class="line">target_match_re:</span><br><span class="line">[ &lt;labelname&gt;: &lt;regex&gt;, ... ]</span><br><span class="line"></span><br><span class="line">source_match:</span><br><span class="line">[ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]</span><br><span class="line">source_match_re:</span><br><span class="line">[ &lt;labelname&gt;: &lt;regex&gt;, ... ]</span><br><span class="line"></span><br><span class="line">[ equal: <span class="string">&#x27;[&#x27;</span> &lt;labelname&gt;, ... <span class="string">&#x27;]&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<p>当已经发送的告警通知匹配到target_match或者target_match_re规则，当有新的告警规则如果满足source_match或者定义的匹配规则，并且已发送的告警与新产生的告警中equal定义的标签完全相同，则启动抑制机制，新的告警不会发送。</p>
<p>例如，定义如下抑制规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- source_match:</span><br><span class="line">  alertname: NodeDown</span><br><span class="line">  severity: critical</span><br><span class="line">target_match:</span><br><span class="line">  severity: critical</span><br><span class="line">equal:</span><br><span class="line">  - node</span><br></pre></td></tr></table></figure>

<p>如当集群中的某一个主机节点异常宕机导致告警NodeDown被触发，同时在告警规则中定义了告警级别severity&#x3D;critical。由于主机异常宕机，该主机上部署的所有服务，中间件会不可用并触发报警。根据抑制规则的定义，如果有新的告警级别为severity&#x3D;critical，并且告警中标签node的值与NodeDown告警的相同，则说明新的告警是由NodeDown导致的，则启动抑制机制停止向接收器发送通知。</p>
<p>演示：实现如果 NodeMemoryUsage 报警触发，则抑制NodeLoad指标规则引起的报警。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">inhibit_rules:</span><br><span class="line">- source_match:</span><br><span class="line">    alertname: NodeMemoryUsage</span><br><span class="line">    severity: critical</span><br><span class="line">  target_match:</span><br><span class="line">    severity: normal;</span><br><span class="line">  equal:</span><br><span class="line">    - instance</span><br></pre></td></tr></table></figure>

<h3 id="Silences：-静默"><a href="#Silences：-静默" class="headerlink" title="Silences： 静默"></a>Silences： 静默</h3><p>简单直接的在指定时段关闭告警。静默通过匹配器（Matcher）来配置，类似于路由树。警告进入系统的时候会检查它是否匹配某条静默规则，如果是则该警告的通知将忽略。静默规则在Alertmanager的Web界面里配置。</p>
<h2 id="告警的生命周期"><a href="#告警的生命周期" class="headerlink" title="告警的生命周期"></a>告警的生命周期</h2><p>一条告警产生后，还要经过 Alertmanager 的分组、抑制处理、静默处理、去重处理和降噪处理最后再发送给接收者。这个过程中可能会因为各种原因会导致告警产生了却最终没有进行通知，可以通过下图了解整个告警的生命周期：</p>
<p><img src="/post/docker/alertmanager-process.png" alt="alertmanager-process"></p>
<h1 id="自定义指标实现业务伸缩"><a href="#自定义指标实现业务伸缩" class="headerlink" title="自定义指标实现业务伸缩"></a>自定义指标实现业务伸缩</h1><h2 id="Kubernetes-Metrics-API体系回顾"><a href="#Kubernetes-Metrics-API体系回顾" class="headerlink" title="Kubernetes Metrics API体系回顾"></a>Kubernetes Metrics API体系回顾</h2><p>前面章节，我们讲过基于CPU和内存的HPA，即利用metrics-server及HPA，可以实现业务服务可以根据pod的cpu和内存进行弹性伸缩。</p>
<p><img src="/post/docker/hpa-prometheus-custom.png" alt="hpa-prometheus-custom"></p>
<p>k8s对监控接口进行了标准化：</p>
<ul>
<li>Resource Metrics 对应的接口是 metrics.k8s.io，主要的实现就是 metrics-server</li>
<li>Custom Metrics 对应的接口是 custom.metrics.k8s.io，主要的实现是 Prometheus， 它提供的是资源监控和自定义监控</li>
</ul>
<p><img src="/post/docker/k8s-metrics.png" alt="k8s-metrics"></p>
<p>安装完metrics-server后，利用kube-aggregator的功能，实现了metrics api的注册。可以通过如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl api-versions</span><br><span class="line">...</span><br><span class="line">metrics.k8s.io/v1beta1</span><br></pre></td></tr></table></figure>

<p>HPA通过使用该API获取监控的CPU和内存资源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询nodes节点的cpu和内存数据</span></span><br><span class="line">$ kubectl get --raw=<span class="string">&quot;/apis/metrics.k8s.io/v1beta1/nodes&quot;</span>|jq</span><br><span class="line">$ kubectl get --raw=<span class="string">&quot;/apis/metrics.k8s.io/v1beta1/pods&quot;</span>|jq</span><br></pre></td></tr></table></figure>

<p>同样，为了实现通用指标的采集，需要部署<code>Prometheus Adapter</code>，来提供<code>custom.metrics.k8s.io</code>，作为HPA获取通用指标的入口。</p>
<h2 id="Adapter安装对接-仅记录没有实验"><a href="#Adapter安装对接-仅记录没有实验" class="headerlink" title="Adapter安装对接(仅记录没有实验)"></a>Adapter安装对接(仅记录没有实验)</h2><p>k8s-prometheus-adapter是一个Prometheus的适配器，它可以将Prometheus的指标数据转换成k8s的Metrics API，从而可以被HPA使用。项目地址在这里 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DirectXMan12/k8s-prometheus-adapter">k8s-prometheus-adapter</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> -b v0.8.4 https://github.com/DirectXMan12/k8s-prometheus-adapter.git</span><br></pre></td></tr></table></figure>

<p>查看部署说明 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DirectXMan12/k8s-prometheus-adapter/tree/v0.8.4/deploy">deploy</a></p>
<ol>
<li><p>镜像使用官方提供的<a target="_blank" rel="external nofollow noopener noreferrer" href="https://hub.docker.com/r/directxman12/k8s-prometheus-adapter/tags">v0.8.4最新版</a></p>
</li>
<li><p>准备证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PURPOSE=serving</span><br><span class="line">$ openssl req -x509 -sha256 -new -nodes -days 3650 -newkey rsa:2048 -keyout <span class="variable">$&#123;PURPOSE&#125;</span>.key -out <span class="variable">$&#123;PURPOSE&#125;</span>.crt -subj <span class="string">&quot;/CN=ca&quot;</span></span><br><span class="line"></span><br><span class="line">$ kubectl -n monitor create secret generic cm-adapter-serving-certs --from-file=./serving.crt --from-file=./serving.key </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">$ kubectl -n monitor describe secret cm-adapter-serving-certs</span><br></pre></td></tr></table></figure>
</li>
<li><p>替换命名空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 资源清单文件默认用的命名空间是custom-metrics，替换为本例中使用的monitor</span></span><br><span class="line">$ sed -i <span class="string">&#x27;s/namespace: custom-metrics/namespace: monitor/g&#x27;</span> manifests/*</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置adapter对接的Prometheus地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于adapter会和Prometheus交互，因此需要配置对接的Prometheus地址</span></span><br><span class="line"><span class="comment"># 替换掉28行：yamls/custom-metrics-apiserver-deployment.yaml 中的--prometheus-url</span></span><br><span class="line">$ vim manifests/custom-metrics-apiserver-deployment.yaml</span><br><span class="line">...</span><br><span class="line">     18     spec:</span><br><span class="line">     19       serviceAccountName: custom-metrics-apiserver</span><br><span class="line">     20       containers:</span><br><span class="line">     21       - name: custom-metrics-apiserver</span><br><span class="line">     22         image: directxman12/k8s-prometheus-adapter-amd64:v0.7.0</span><br><span class="line">     23         args:</span><br><span class="line">     24         - --secure-port=6443</span><br><span class="line">     25         - --tls-cert-file=/var/run/serving-cert/serving.crt</span><br><span class="line">     26         - --tls-private-key-file=/var/run/serving-cert/serving.key</span><br><span class="line">     27         - --logtostderr=<span class="literal">true</span></span><br><span class="line">     28         - --prometheus-url=http://prometheus:9090/</span><br><span class="line">     29         - --metrics-relist-interval=1m</span><br><span class="line">     30         - --v=10</span><br><span class="line">     31         - --config=/etc/adapter/config.yaml</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mv</span> manifests/custom-metrics-config-map.yaml .</span><br><span class="line">$ vi manifests/custom-metrics-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: adapter-config</span><br><span class="line">  namespace: monitor</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |</span><br><span class="line">    rules:</span><br><span class="line">    - &#123;&#125;</span><br><span class="line">$ kubectl apply -f manifests/</span><br></pre></td></tr></table></figure></li>
</ol>
<p>完成后验证一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl api-versions|grep metrics</span><br><span class="line">custom.metrics.k8s.io/v1beta1</span><br><span class="line">custom.metrics.k8s.io/v1beta2</span><br><span class="line">external.metrics.k8s.io/v1beta1</span><br><span class="line">metrics.k8s.io/v1beta1</span><br><span class="line"></span><br><span class="line">$ kubectl get --raw /apis/custom.metrics.k8s.io/v1beta2 |jq</span><br><span class="line">&#123;                                                    </span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIResourceList&quot;</span>,                         </span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;groupVersion&quot;</span>: <span class="string">&quot;custom.metrics.k8s.io/v1beta2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resources&quot;</span>: []                                    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="配置自定义指标"><a href="#配置自定义指标" class="headerlink" title="配置自定义指标"></a>配置自定义指标</h1><h2 id="通用指标示例程序部署"><a href="#通用指标示例程序部署" class="headerlink" title="通用指标示例程序部署"></a>通用指标示例程序部署</h2><p><img src="/post/docker/hpa-prometheus-custom.png" alt="hpa-prometheus-custom"></p>
<p>为了演示效果，我们新建一个deployment来模拟业务应用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> custom-metrics-demo.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-metrics-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: custom-metrics-demo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: custom-metrics-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: custom-metrics-demo</span><br><span class="line">        image: luxas/autoscale-demo:v0.1.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 50m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br></pre></td></tr></table></figure>

<p>部署应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f custom-metrics-demo.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl get po -o wide</span><br><span class="line">custom-metrics-demo-95b5bc949-xpppl   1/1     Running   0          65s   10.244.1.194</span><br><span class="line"></span><br><span class="line">$ curl 10.244.1.194:8080/metrics</span><br><span class="line"><span class="comment"># HELP http_requests_total The amount of requests served by the server in total</span></span><br><span class="line"><span class="comment"># TYPE http_requests_total counter</span></span><br><span class="line">http_requests_total 2</span><br></pre></td></tr></table></figure>

<p>注册为Prometheus的target：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> custom-metrics-demo-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: custom-metrics-demo</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: <span class="string">&quot;true&quot;</span></span><br><span class="line">    prometheus.io/port: <span class="string">&quot;8080&quot;</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: custom-metrics-demo</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br></pre></td></tr></table></figure>

<p>自动注册为Prometheus的采集Targets。</p>
<p>通常web类的应用，会把每秒钟的请求数作为业务伸缩的指标依据。</p>
<p>部署完成，接下我们需要进行测试了。但是测试前还有一些问题得解决。</p>
<p>使用案例应用<code>custom-metrics-demo</code>，如果<code>custom-metrics-demo</code>最近1分钟内每秒钟的请求数超过10次，则自动扩充业务应用的副本数。</p>
<ul>
<li><p>配置自定义指标</p>
<p>告诉Adapter去采集转换哪些指标，Adapter支持转换的指标，才可以作为HPA的依据</p>
</li>
<li><p>配置HPA规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling/v2beta1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: front-app-hpa</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: custom-metrics-demo</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  maxReplicas: 3</span><br><span class="line">  metrics:</span><br><span class="line">  - <span class="built_in">type</span>: Pods</span><br><span class="line">    pods:</span><br><span class="line">      metricName: http_requests_per_second</span><br><span class="line">      targetAverageValue: 10</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Adapter配置自定义指标"><a href="#Adapter配置自定义指标" class="headerlink" title="Adapter配置自定义指标"></a>Adapter配置自定义指标</h2><p><img src="/post/docker/customer-metrics.png" alt="customer-metrics"></p>
<p>前面讲CPU的平均使用率的采集，其实是通过<code>node_cpu_seconds_total</code>指标计算得到的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line">│   . . . . . . . . . . . . . . . . .   . .   node_cpu&#123;cpu=<span class="string">&quot;cpu0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;</span><br><span class="line">│     . . . . . . . . . . . . . . . . . . .   node_cpu&#123;cpu=<span class="string">&quot;cpu0&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125;</span><br><span class="line">│     . . . . . . . . . .   . . . . . . . .   node_load1&#123;&#125;</span><br><span class="line">│     . . . . . . . . . . . . . . . .   . .   node_cpu_seconds_total&#123;...&#125;</span><br><span class="line">v</span><br><span class="line">  &lt;------------------ 时间 ----------------&gt;</span><br></pre></td></tr></table></figure>

<p>同样，如果想获得每个业务应用最近1分钟内每秒的访问次数，也是根据总数来做计算，因此，需要使用业务自定义指标<code>http_requests_total</code>，配合<code>rate</code>方法即可获取每秒钟的请求数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rate(http_requests_total[2m])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如查询有多条数据，需做汇聚，需要使用sum</span></span><br><span class="line"><span class="built_in">sum</span>(rate(http_requests_total[2m])) by(kubernetes_pod_name)</span><br></pre></td></tr></table></figure>

<ol>
<li><p>自定义指标可以配置多个，因此，需要将规则使用数组来配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>告诉Adapter，哪些自定义指标可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- seriesQuery: <span class="string">&#x27;http_requests_total&#123;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>seriesQuery是PromQL语句，和直接用<code>http_requests_total</code>查询到的结果一样，凡是seriesQuery可以查询到的指标，都可以用作自定义指标</p>
</li>
<li><p>告诉Adapter，指标中的标签和k8s中的资源对象的关联关系</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- seriesQuery: <span class="string">&#x27;http_requests_total&#123;&#125;&#x27;</span></span><br><span class="line">  resources:</span><br><span class="line">    overrides:</span><br><span class="line">      kubernetes_namespace: &#123;resource: <span class="string">&quot;namespace&quot;</span>&#125;</span><br><span class="line">      kubernetes_pod_name: &#123;resource: <span class="string">&quot;pod&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>hpa 拿着k8s里的namepace和pod名称，来查询adaptor，adaptor去查询Prometheus的时候根据resources的适配来转换，namepace&#x3D;default, pod&#x3D;front-app-xxxx,  kubernetes_namespace&#x3D;”default”</p>
<p>我们查询到的可用指标格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_requests_total&#123;instance=<span class="string">&quot;10.244.2.140:8080&quot;</span>, job=<span class="string">&quot;kubernetes-sd-endpoints&quot;</span>, kubernetes_name=<span class="string">&quot;custom-metrics-demo&quot;</span>, kubernetes_namespace=<span class="string">&quot;default&quot;</span>, kubernetes_pod_name=<span class="string">&quot;front-app-df5fc79dd-rmzr6&quot;</span>, namespace=<span class="string">&quot;default&quot;</span>, pod=<span class="string">&quot;front-app-df5fc79dd-rmzr6&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>由于HPA在调用Adapter接口的时候，告诉Adapter的是查询哪个命名空间下的哪个Pod的指标，因此，Adapter在去查询的时候，需要做一层适配转换（因为并不是每个prometheus查询到的结果中都是叫做<code>kubernetes_namespace</code>和<code>kubernetes_pod_name</code>）</p>
<p><code>/apis/custom.metrics.k8s.io/v1beta2/namespaces/default/pods/xxx/http_requests_total</code></p>
</li>
<li><p>指定自定义的指标名称，供HPA配置使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- seriesQuery: <span class="string">&#x27;http_requests_total&#123;&#125;&#x27;</span></span><br><span class="line">  resources:</span><br><span class="line">    overrides:</span><br><span class="line">      kubernetes_namespace: &#123;resource: <span class="string">&quot;namespace&quot;</span>&#125;</span><br><span class="line">      kubernetes_pod_name: &#123;resource: <span class="string">&quot;pod&quot;</span>&#125;</span><br><span class="line">  name:</span><br><span class="line">    as: <span class="string">&quot;http_requests_per_second&quot;</span></span><br></pre></td></tr></table></figure>

<p>因为Adapter转换完之后的指标含义为：每秒钟的请求数。因此提供指标名称，该配置根据正则表达式做了匹配替换，转换完后的指标名称为：<code>http_requests_per_second</code>，HPA规则中可以直接配置该名称。</p>
</li>
<li><p>告诉Adapter如何获取最终的自定义指标值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">- seriesQuery: <span class="string">&#x27;http_requests_total&#123;&#125;&#x27;</span></span><br><span class="line">  resources:</span><br><span class="line">    overrides:</span><br><span class="line">      kubernetes_namespace: &#123;resource: <span class="string">&quot;namespace&quot;</span>&#125;</span><br><span class="line">      kubernetes_pod_name: &#123;resource: <span class="string">&quot;pod&quot;</span>&#125;</span><br><span class="line">  name:</span><br><span class="line">    as: <span class="string">&quot;http_requests_per_second&quot;</span></span><br><span class="line">  metricsQuery: <span class="string">&#x27;sum(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>我们最终期望的写法可能是这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(rate(http_requests_total&#123;kubernetes_namespace=<span class="string">&quot;default&quot;</span>,kubernetes_pod_name=<span class="string">&quot;xxxx&quot;</span>&#125;[2m])) by (kubernetes_pod_name)</span><br></pre></td></tr></table></figure>

<p>但是Adapter提供了更简单的写法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Series</code>: 指标名称<ul>
<li><code>LabelMatchers</code>: 指标查询的label</li>
<li><code>GroupBy</code>: 结果分组，针对HPA过来的查询，都会匹配成<code>kubernetes_pod_name</code></li>
</ul>
</li>
</ul>
<p>更新Adapter的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ vi custom-metrics-configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: adapter-config</span><br><span class="line">  namespace: monitor</span><br><span class="line">data:</span><br><span class="line">  config.yaml: |</span><br><span class="line">    rules:</span><br><span class="line">    - seriesQuery: <span class="string">&#x27;http_requests_total&#x27;</span></span><br><span class="line">      seriesFilters: []</span><br><span class="line">      resources:</span><br><span class="line">        overrides:</span><br><span class="line">          kubernetes_namespace: &#123;resource: <span class="string">&quot;namespace&quot;</span>&#125;</span><br><span class="line">          kubernetes_pod_name: &#123;resource: <span class="string">&quot;pod&quot;</span>&#125;</span><br><span class="line">      name:</span><br><span class="line">        as: <span class="string">&quot;http_requests_per_second&quot;</span></span><br><span class="line">      metricsQuery: (<span class="built_in">sum</span>(rate(&lt;&lt;.Series&gt;&gt;&#123;&lt;&lt;.LabelMatchers&gt;&gt;&#125;[1m])) by (&lt;&lt;.GroupBy&gt;&gt;))</span><br></pre></td></tr></table></figure>

<p>需要更新configmap并重启adapter服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f custom-metrics-configmap.yaml</span><br><span class="line">$ kubectl -n monitor delete po custom-metrics-apiserver-c689ff947-zp8gq</span><br></pre></td></tr></table></figure>

<p>再次查看可用的指标数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1 |jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;APIResourceList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;groupVersion&quot;</span>: <span class="string">&quot;custom.metrics.k8s.io/v1beta2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;namespaces/http_requests_per_second&quot;</span>,</span><br><span class="line">      <span class="string">&quot;singularName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;namespaced&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;MetricValueList&quot;</span>,</span><br><span class="line">      <span class="string">&quot;verbs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;pods/http_requests_per_second&quot;</span>,</span><br><span class="line">      <span class="string">&quot;singularName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;namespaced&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;MetricValueList&quot;</span>,</span><br><span class="line">      <span class="string">&quot;verbs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际中，hpa会去对如下地址发起请求，获取数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get --raw /apis/custom.metrics.k8s.io/v1beta2/namespaces/default/pods/*/http_requests_per_second |jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;MetricValueList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;custom.metrics.k8s.io/v1beta2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;selfLink&quot;</span>: <span class="string">&quot;/apis/custom.metrics.k8s.io/v1beta2/namespaces/default/pods/%2A/http_requests_per_second&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;describedObject&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Pod&quot;</span>,</span><br><span class="line">        <span class="string">&quot;namespace&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;front-app-df5fc79dd-rmzr6&quot;</span>,</span><br><span class="line">        <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;/v1&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;metric&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;http_requests_per_second&quot;</span>,</span><br><span class="line">        <span class="string">&quot;selector&quot;</span>: null</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;timestamp&quot;</span>: <span class="string">&quot;2021-07-02T09:24:12Z&quot;</span>,</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: <span class="string">&quot;33m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中33m等于0.033，即当前指标查询每秒钟请求数为0.033次.</p>
<p>我们发现有两个可用的resources，引用官方的一段解释：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Notice that we get an entry <span class="keyword">for</span> both <span class="string">&quot;pods&quot;</span> and <span class="string">&quot;namespaces&quot;</span> -- the adapter exposes the metric on each resource that we<span class="string">&#x27;ve associated the metric with (and all namespaced resources must be associated with a namespace), and will fill in the &lt;&lt;.GroupBy&gt;&gt; section with the appropriate label depending on which we ask for.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">We can now connect to $KUBERNETES/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/nginx_vts_server_requests_per_second, and we should see</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DirectXMan12/k8s-prometheus-adapter/blob/master/docs/config-walkthrough.md">https://github.com/DirectXMan12/k8s-prometheus-adapter/blob/master/docs/config-walkthrough.md</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/DirectXMan12/k8s-prometheus-adapter/blob/master/docs/config.md">https://github.com/DirectXMan12/k8s-prometheus-adapter/blob/master/docs/config.md</a> </p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/k8s-prometheus-grafana/">k8s prometheus 展示与告警</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">aaron</a></p>
        <p><span>发布时间:</span>2023-12-06, 13:51:19</p>
        <p><span>最后更新:</span>2023-12-12, 01:33:52</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/k8s-prometheus-grafana/" title="k8s prometheus 展示与告警">http://realtiger.github.io/k8s-prometheus-grafana/</a>
            <span class="copy-path" data-clipboard-text="原文: http://realtiger.github.io/k8s-prometheus-grafana/　　作者: aaron" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="external nofollow noopener noreferrer" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/k8s-devops-jenkins/">
                    jenkins 初体验
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/k8s-prometheus-add-targets/">
                    k8s prometheus 添加监控目标
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Grafana%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">Grafana介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Grafana"><span class="toc-number">2.</span> <span class="toc-text">安装Grafana</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF"><span class="toc-number">3.</span> <span class="toc-text">导入监控面板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5Dashboard%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">导入Dashboard的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84Dashboard"><span class="toc-number">3.1.1.</span> <span class="toc-text">官方提供的Dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-Exporter"><span class="toc-number">3.1.2.</span> <span class="toc-text">Node Exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes"><span class="toc-number">3.1.3.</span> <span class="toc-text">Kubernetes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DevOpsProdigy-KubeGraf%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.1.4.</span> <span class="toc-text">DevOpsProdigy KubeGraf插件的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF"><span class="toc-number">3.1.5.</span> <span class="toc-text">自定义监控面板</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Metrics%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B%E4%B8%8EPromQL"><span class="toc-number">4.</span> <span class="toc-text">Metrics指标类型与PromQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Guage%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">Guage类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Counter%E7%B1%BB%E5%9E%8B%EF%BC%9A"><span class="toc-number">4.2.</span> <span class="toc-text">Counter类型：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Alertmanager"><span class="toc-number">5.</span> <span class="toc-text">Alertmanager</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">5.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEPrometheus%E4%B8%8EAlertmanager%E5%AF%B9%E8%AF%9D"><span class="toc-number">5.2.</span> <span class="toc-text">配置Prometheus与Alertmanager对话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">5.3.</span> <span class="toc-text">配置告警规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89webhook%E5%AE%9E%E7%8E%B0%E5%91%8A%E8%AD%A6%E6%B6%88%E6%81%AF%E7%9A%84%E6%8E%A8%E9%80%81"><span class="toc-number">5.4.</span> <span class="toc-text">自定义webhook实现告警消息的推送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ELabel%E7%9A%84%E5%8A%A8%E6%80%81%E5%91%8A%E8%AD%A6%E5%A4%84%E7%90%86"><span class="toc-number">5.5.</span> <span class="toc-text">基于Label的动态告警处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%91%E5%88%B6%E5%92%8C%E9%9D%99%E9%BB%98"><span class="toc-number">5.6.</span> <span class="toc-text">抑制和静默</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Inhibition-%E6%8A%91%E5%88%B6"><span class="toc-number">5.6.1.</span> <span class="toc-text">Inhibition 抑制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Silences%EF%BC%9A-%E9%9D%99%E9%BB%98"><span class="toc-number">5.6.2.</span> <span class="toc-text">Silences： 静默</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">5.7.</span> <span class="toc-text">告警的生命周期</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87%E5%AE%9E%E7%8E%B0%E4%B8%9A%E5%8A%A1%E4%BC%B8%E7%BC%A9"><span class="toc-number">6.</span> <span class="toc-text">自定义指标实现业务伸缩</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes-Metrics-API%E4%BD%93%E7%B3%BB%E5%9B%9E%E9%A1%BE"><span class="toc-number">6.1.</span> <span class="toc-text">Kubernetes Metrics API体系回顾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Adapter%E5%AE%89%E8%A3%85%E5%AF%B9%E6%8E%A5-%E4%BB%85%E8%AE%B0%E5%BD%95%E6%B2%A1%E6%9C%89%E5%AE%9E%E9%AA%8C"><span class="toc-number">6.2.</span> <span class="toc-text">Adapter安装对接(仅记录没有实验)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87"><span class="toc-number">7.</span> <span class="toc-text">配置自定义指标</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E6%8C%87%E6%A0%87%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F%E9%83%A8%E7%BD%B2"><span class="toc-number">7.1.</span> <span class="toc-text">通用指标示例程序部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Adapter%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87"><span class="toc-number">7.2.</span> <span class="toc-text">Adapter配置自定义指标</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"k8s prometheus 展示与告警　| 一雾银的博客　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/k8s-devops-jenkins/" title="上一篇: jenkins 初体验">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/k8s-prometheus-add-targets/" title="下一篇: k8s prometheus 添加监控目标">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/python-httpx/">python第三方网络库httpx</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-devops-jenkins/">jenkins 初体验</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-prometheus-grafana/">k8s prometheus 展示与告警</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-prometheus-add-targets/">k8s prometheus 添加监控目标</a></li><li class="post-list-item"><a class="post-list-link" href="/linux-iptables/">linux iptables 防火墙</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-prometheus-introduction-install/">k8s prometheus监控</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-helm/">k8s helm</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-cni/">k8s 容器网络接口</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-persistent-volume/">k8s 持久卷</a></li><li class="post-list-item"><a class="post-list-link" href="/generate-a-self-signed-ssl-certificate/">生成自签名SSL证书</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-hpa/">k8s 动态扩缩容</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-auth/">k8s 认证和授权</a></li><li class="post-list-item"><a class="post-list-link" href="/rabbitmq-for-python/">rabbitmq for python</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-scheduler/">k8s 调度</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-etcd/">k8s etcd</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-service-discovery-and-load-balance/">k8s 服务发现和负载均衡</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-service/">k8s service</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-deployment/">k8s deployment</a></li><li class="post-list-item"><a class="post-list-link" href="/pod-settings-and-config/">pod 常用设置和配置</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-force-delete-resource/">k8s 强制删除 pod/pvc/pv/ns 的方法</a></li><li class="post-list-item"><a class="post-list-link" href="/linux-systemd-service-file/">linux中systemd及其service文件</a></li><li class="post-list-item"><a class="post-list-link" href="/linux-signals/">linux 信号介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-learning/">k8s 学习笔记总目录</a></li><li class="post-list-item"><a class="post-list-link" href="/k8s-introduction/">k8s 介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/containerd-introduction/">containerd 介绍 与 docker 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-network/">Docker 网络</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-service-running-principle/">docker 运行原理</a></li><li class="post-list-item"><a class="post-list-link" href="/sphinx-python-documentation-generator/">sphinx - python文档生成器</a></li><li class="post-list-item"><a class="post-list-link" href="/centos8-python-upgrade/">centos8 升级 python 版本</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-file/">docker file</a></li><li class="post-list-item"><a class="post-list-link" href="/yaml-introduction/">yaml 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-introduction/">docker 介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/python-design-patterns-02/">python 设计模式 02</a></li><li class="post-list-item"><a class="post-list-link" href="/python-design-patterns-03/">python 设计模式 03</a></li><li class="post-list-item"><a class="post-list-link" href="/python-design-patterns-01/">python 设计模式 01</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2023 aaron
            </div>
            <div class="footer-right">
                <!--<a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>-->
                <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 10;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>




    <script async src="/live2d-widget/autoload.js"></script>


  </div>
</body>
</html>